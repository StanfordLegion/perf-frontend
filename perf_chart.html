<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Legion Performance Testing</title>
  </head>
  <body>

    <canvas id="myChart" width="400" height="400"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.bundle.min.js"></script>
    <script>
    // Utility function to fetch JSON.
    var getJSON = function(url, callback) {
      var xhr = new XMLHttpRequest();
      xhr.open("get", url, true);
      xhr.responseType = "json";
      xhr.onload = function() {
        var status = xhr.status;
        if (status == 200) {
          callback(null, xhr.response);
        } else {
        callback(status);
        }
      };
      xhr.send();
    };

    var make_line_chart = function(data) {
      var ctx = document.getElementById("myChart");
      var myChart = new Chart(ctx, {
        type: "line",
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          legend: {
            position: "left",
          },
        },
      });
    }

    // Generate chart data from measurements.
    var get_measurement_data = function(data, branch, measurement_type) {
      var commits = data["commits"][branch];
      var measurements = data["measurements"];
      var data_by_benchmark_argv_host_commit = {};

      var benchmarks = [];
      var argv_by_benchmark = {};
      var host_by_benchmark_argv = {};

      var commit_count = commits.length;
      for (var commit_i = 0; commit_i < commit_count; commit_i++) {
        var commit = commits[commit_i];
        var measurement_count = measurements[commit].length;
        for (var measurement_i = 0; measurement_i < measurement_count; measurement_i++) {
          var measurement = measurements[commit][measurement_i];
          if (measurement["metadata"]["branch"] == branch) {
            var benchmark = measurement["metadata"]["benchmark"];
            var argv = measurement["metadata"]["argv"];
            var host = measurement["metadata"]["host"];

            if (!data_by_benchmark_argv_host_commit[benchmark]) {
              data_by_benchmark_argv_host_commit[benchmark] = {};
              benchmarks.push(benchmark);
              argv_by_benchmark[benchmark] = [];
              host_by_benchmark_argv[benchmark] = {};
            }
            if (!data_by_benchmark_argv_host_commit[benchmark][argv]) {
              data_by_benchmark_argv_host_commit[benchmark][argv] = {};
              argv_by_benchmark[benchmark].push(argv);
              host_by_benchmark_argv[benchmark][argv] = [];
            }
            if (!data_by_benchmark_argv_host_commit[benchmark][argv][host]) {
              data_by_benchmark_argv_host_commit[benchmark][argv][host] = {};
              host_by_benchmark_argv[benchmark][argv].push(host);
            }
            // FIXME: If there are multiple matching entries, this
            // will just pick one. Would be nice to take a mean or
            // something.
            data_by_benchmark_argv_host_commit[benchmark][argv][host][commit] =
              measurement["measurements"][measurement_type];
          }
        }
      }

      var colors = [
        'rgba(255,99,132,1)',
        'rgba(54, 162, 235, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(255, 159, 64, 1)'
      ];
      var color_count = colors.length;
      var color_i = 0;

      var datasets = [];
      var benchmark_count = benchmarks.length;
      for (var benchmark_i = 0; benchmark_i < benchmark_count; benchmark_i++) {
        var benchmark = benchmarks[benchmark_i];
        var argv_count = argv_by_benchmark[benchmark].length;
        for (var argv_i = 0; argv_i < argv_count; argv_i++) {
          var argv = argv_by_benchmark[benchmark][argv_i];
          var host_count = host_by_benchmark_argv[benchmark][argv].length;
          for (var host_i = 0; host_i < host_count; host_i++) {
            var host = host_by_benchmark_argv[benchmark][argv][host_i];

            var data = [];
            var measurements = data_by_benchmark_argv_host_commit[benchmark][argv][host];
            var commit_count = commits.length;
            for (var commit_i = 0; commit_i < commit_count; commit_i++) {
              var commit = commits[commit_i];
              data.push(measurements[commit]);
            }

            var color = colors[color_i];
            color_i = (color_i + 1) % color_count;

            var dataset = {
              label: benchmark + " / " + argv + " / " + host,
              data: data,
              fill: false,
              pointRadius: 7,
              pointHoverRadius: 10,
              backgroundColor: color,
              borderColor: color,
              borderWidth: 3,
            }
            datasets.push(dataset);
          }
        }
      }

      var labels = [];
      var commit_count = commits.length;
      for (var commit_i = 0; commit_i < commit_count; commit_i++) {
        var commit = commits[commit_i];
        var label = commit.substring(0, 7);
        labels.push(label);
      }

      return {
        labels: labels,
        datasets: datasets,
      };
    }

    var render = function(json_data) {
      // Right now just render the master branch and execution time.
      var branch = "master";
      var measurement_type = "time_seconds";
      var chart_data = get_measurement_data(json_data, branch, measurement_type);
      make_line_chart(chart_data);
    }

    getJSON("https://raw.githubusercontent.com/StanfordLegion/perf-data/master/rendered/chart.json",
      function(err, data) {
        if (err != null) {
          alert("Error: " + err);
        } else {
          render(data);
        }
      });

    </script>
  </body>
</html>
